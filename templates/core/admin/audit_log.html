{% extends 'core/admin/base.html' %}

{% block title %}Audit Log{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold">Audit Log</h1>
    <p class="text-gray-400 mt-1">Track admin and management actions across the platform</p>
</div>

<!-- Filters -->
<div class="flex gap-2 mb-6 flex-wrap">
    <a href="{% url 'admin_audit_log' %}"
       class="px-3 py-1 rounded text-sm {% if not action_filter %}bg-ch-gold text-black{% else %}bg-ch-gray text-gray-300 hover:bg-gray-600{% endif %}">
        All
    </a>
    {% for value, label in action_choices %}
    <a href="{% url 'admin_audit_log' %}?action={{ value }}"
       class="px-3 py-1 rounded text-sm {% if action_filter == value %}bg-ch-gold text-black{% else %}bg-ch-gray text-gray-300 hover:bg-gray-600{% endif %}">
        {{ label }}
    </a>
    {% endfor %}
</div>

<!-- Log Table -->
<div class="bg-ch-dark rounded-lg overflow-hidden">
    <table class="min-w-full">
        <thead class="bg-ch-gray">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Time</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">User</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Action</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Organization</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Target</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase">Details</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-800">
            {% for log in logs %}
            <tr class="hover:bg-ch-gray/50">
                <td class="px-4 py-3 text-sm text-gray-300 whitespace-nowrap">
                    {{ log.timestamp|date:"M d, Y H:i" }}
                </td>
                <td class="px-4 py-3 text-sm">
                    {% if log.user %}{{ log.user.email }}{% else %}<span class="text-gray-500">System</span>{% endif %}
                </td>
                <td class="px-4 py-3 text-sm">
                    <span class="px-2 py-1 rounded text-xs
                        {% if 'approve' in log.action %}bg-green-900 text-green-300
                        {% elif 'reject' in log.action or 'remove' in log.action %}bg-red-900 text-red-300
                        {% elif 'impersonate' in log.action %}bg-yellow-900 text-yellow-300
                        {% else %}bg-blue-900 text-blue-300{% endif %}">
                        {{ log.get_action_display }}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-300">
                    {% if log.organization %}{{ log.organization.name }}{% else %}-{% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-300">
                    {% if log.target_user %}{{ log.target_user.email }}{% else %}-{% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-400 max-w-xs truncate">
                    {% for key, value in log.details.items %}{{ key }}: {{ value }}{% if not forloop.last %}, {% endif %}{% endfor %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">No audit log entries yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if logs.has_other_pages %}
<div class="flex justify-center gap-2 mt-6">
    {% if logs.has_previous %}
    <a href="?page={{ logs.previous_page_number }}{% if action_filter %}&action={{ action_filter }}{% endif %}"
       class="px-3 py-1 bg-ch-gray rounded text-sm hover:bg-gray-600">Previous</a>
    {% endif %}
    <span class="px-3 py-1 text-sm text-gray-400">Page {{ logs.number }} of {{ logs.paginator.num_pages }}</span>
    {% if logs.has_next %}
    <a href="?page={{ logs.next_page_number }}{% if action_filter %}&action={{ action_filter }}{% endif %}"
       class="px-3 py-1 bg-ch-gray rounded text-sm hover:bg-gray-600">Next</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}
