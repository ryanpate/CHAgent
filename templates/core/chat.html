{% extends 'base.html' %}

{% block title %}Ask Aria{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h2 class="font-display text-2xl">Ask Aria</h2>
        <div class="flex gap-2">
            <button onclick="copyConversation()"
                    id="copy-btn"
                    class="px-4 py-2 bg-ch-gray hover:bg-gray-600 rounded-lg transition flex items-center gap-2"
                    title="Copy conversation to clipboard">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                <span id="copy-btn-text">Copy</span>
            </button>
            <button hx-post="{% url 'chat_new_session' %}"
                    hx-target="#chat-messages"
                    hx-swap="innerHTML"
                    class="px-4 py-2 bg-ch-gray hover:bg-ch-gold hover:text-black rounded-lg transition">
                New Conversation
            </button>
        </div>
    </div>

    <!-- Chat Messages -->
    <div id="chat-messages" class="bg-ch-dark rounded-lg p-6 h-[500px] overflow-y-auto mb-4 space-y-4">
        {% for message in chat_messages %}
        <div class="{% if message.role == 'user' %}ml-12{% else %}mr-12{% endif %}">
            <div class="{% if message.role == 'user' %}bg-ch-gold text-black{% else %}bg-ch-gray markdown-content{% endif %} rounded-lg p-4">
                {% if message.role == 'user' %}{{ message.content|linebreaks }}{% else %}{{ message.content }}{% endif %}
            </div>
            <div class="flex items-center justify-between mt-1">
                <p class="text-xs text-gray-500 {% if message.role == 'user' %}text-right w-full{% endif %}">
                    {{ message.created_at|timesince }} ago
                </p>
                {% if message.role == 'assistant' %}
                <!-- Feedback buttons for AI responses -->
                <div id="feedback-{{ message.id }}" class="flex items-center gap-1">
                    {% if message.feedback %}
                    <span class="text-xs text-gray-500">
                        {% if message.feedback.feedback_type == 'positive' %}
                        <svg class="w-4 h-4 text-green-400 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"></path>
                        </svg>
                        {% else %}
                        <svg class="w-4 h-4 text-red-400 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M18 9.5a1.5 1.5 0 11-3 0v-6a1.5 1.5 0 013 0v6zM14 9.667v-5.43a2 2 0 00-1.106-1.79l-.05-.025A4 4 0 0011.057 2H5.64a2 2 0 00-1.962 1.608l-1.2 6A2 2 0 004.44 12H8v4a2 2 0 002 2 1 1 0 001-1v-.667a4 4 0 01.8-2.4l1.4-1.866a4 4 0 00.8-2.4z"></path>
                        </svg>
                        {% endif %}
                        Thanks!
                    </span>
                    {% else %}
                    <button hx-post="{% url 'chat_feedback' %}"
                            hx-vals='{"message_id": "{{ message.id }}", "feedback_type": "positive"}'
                            hx-target="#feedback-{{ message.id }}"
                            hx-swap="innerHTML"
                            class="text-gray-500 hover:text-green-400 transition p-1"
                            title="Helpful response">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
                        </svg>
                    </button>
                    <button hx-post="{% url 'chat_feedback' %}"
                            hx-vals='{"message_id": "{{ message.id }}", "feedback_type": "negative"}'
                            hx-target="#feedback-{{ message.id }}"
                            hx-swap="innerHTML"
                            class="text-gray-500 hover:text-red-400 transition p-1"
                            title="Not helpful">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"></path>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="text-center text-gray-400 py-8" id="chat-welcome">
            <p class="mb-4 text-lg">Hi, I'm Aria! Here's what I can help you with:</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 max-w-2xl mx-auto text-sm">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-ch-gold flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Log volunteer interactions
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-ch-gold flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Look up contact info (email, phone)
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-ch-gold flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Check service schedules
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-ch-gold flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                    </svg>
                    View blockouts & availability
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-ch-gold flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                    </svg>
                    Look up song history & setlists
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-ch-gold flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Get chord charts & lyrics
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-ch-gold flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                    Track prayer requests
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-ch-gold flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Get team insights & summaries
                </div>
            </div>
            <p class="mt-5 text-gray-500 text-sm">Try: "Who's serving this Sunday?" • "What's Sarah's email?" • "When was 'Goodness of God' last played?"</p>
        </div>
        {% endfor %}
    </div>

    <!-- Thinking Indicator (hidden by default, shown during request) -->
    <div id="aria-thinking" class="hidden mr-12">
        <div class="bg-ch-gray rounded-lg p-4">
            <div class="flex items-center gap-3">
                <div class="flex gap-1">
                    <span class="w-2 h-2 bg-ch-gold rounded-full animate-bounce" style="animation-delay: 0ms;"></span>
                    <span class="w-2 h-2 bg-ch-gold rounded-full animate-bounce" style="animation-delay: 150ms;"></span>
                    <span class="w-2 h-2 bg-ch-gold rounded-full animate-bounce" style="animation-delay: 300ms;"></span>
                </div>
                <span id="aria-thinking-text" class="text-gray-300">Aria is thinking...</span>
            </div>
            <p id="aria-thinking-detail" class="text-xs text-gray-500 mt-2 hidden">This may take a moment while checking availability across the team.</p>
        </div>
    </div>

    <!-- Input Form -->
    <form hx-post="{% url 'chat_send' %}"
          hx-target="#chat-messages"
          hx-swap="beforeend"
          hx-on::before-request="showThinkingIndicator(this)"
          hx-on::after-request="hideThinkingIndicator(); this.reset(); document.getElementById('chat-welcome')?.remove(); document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;"
          class="flex gap-4">
        {% csrf_token %}
        <input type="text"
               name="message"
               placeholder="Log an interaction or ask a question..."
               class="flex-1 bg-ch-dark border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-ch-gold transition"
               autocomplete="off"
               required>
        <button type="submit"
                class="bg-ch-gold text-black px-6 py-3 rounded-lg font-medium hover:bg-yellow-500 transition flex items-center gap-2">
            <span>Send</span>
            <span class="htmx-indicator">
                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </span>
        </button>
    </form>

    <!-- Quick Actions -->
    <div class="mt-4 flex gap-2 flex-wrap">
        <button class="quick-action" onclick="setMessage('Log interaction: ')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Log Interaction
        </button>
        <button class="quick-action" onclick="setMessage('Who is serving this Sunday?')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            This Sunday's Team
        </button>
        <button class="quick-action" onclick="setMessage('What songs did we play last Sunday?')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
            </svg>
            Last Setlist
        </button>
        <button class="quick-action" onclick="setMessage('Who is blocked out this Sunday?')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
            </svg>
            Check Blockouts
        </button>
        <button class="quick-action" onclick="setMessage('What do we know about ')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            Find Volunteer
        </button>
        <button class="quick-action" onclick="setMessage('Show recent prayer requests')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
            Prayer Requests
        </button>
    </div>
</div>

<script>
function setMessage(text) {
    const input = document.querySelector('input[name="message"]');
    input.value = text;
    input.focus();
}

function copyConversation() {
    const chatContainer = document.getElementById('chat-messages');
    const messages = chatContainer.querySelectorAll(':scope > div:not(#chat-welcome)');

    if (messages.length === 0) {
        showCopyFeedback('No messages to copy', false);
        return;
    }

    let conversationText = '';

    messages.forEach((msgDiv) => {
        // Determine if user or assistant
        const isUser = msgDiv.classList.contains('ml-12');
        const role = isUser ? 'User' : 'Aria';

        // Get the message content
        const contentDiv = msgDiv.querySelector('.rounded-lg.p-4');
        if (contentDiv) {
            // Get text content, preserving some structure
            let content = contentDiv.innerText || contentDiv.textContent;
            content = content.trim();

            // Get timestamp if available
            const timeEl = msgDiv.querySelector('.text-xs.text-gray-500');
            const timestamp = timeEl ? timeEl.textContent.trim() : '';

            conversationText += `${role}:\n${content}\n`;
            if (timestamp) {
                conversationText += `(${timestamp})\n`;
            }
            conversationText += '\n';
        }
    });

    // Add header with current date
    const header = `=== Aria WA Conversation ===\nCopied: ${new Date().toLocaleString()}\n\n`;
    conversationText = header + conversationText;

    // Copy to clipboard
    navigator.clipboard.writeText(conversationText).then(() => {
        showCopyFeedback('Copied!', true);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        fallbackCopy(conversationText);
    });
}

function showCopyFeedback(message, success) {
    const btnText = document.getElementById('copy-btn-text');
    const btn = document.getElementById('copy-btn');
    const originalText = btnText.textContent;

    btnText.textContent = message;
    if (success) {
        btn.classList.add('bg-green-600');
        btn.classList.remove('bg-ch-gray');
    } else {
        btn.classList.add('bg-red-600');
        btn.classList.remove('bg-ch-gray');
    }

    setTimeout(() => {
        btnText.textContent = originalText;
        btn.classList.remove('bg-green-600', 'bg-red-600');
        btn.classList.add('bg-ch-gray');
    }, 2000);
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        document.execCommand('copy');
        showCopyFeedback('Copied!', true);
    } catch (err) {
        showCopyFeedback('Failed to copy', false);
    }

    document.body.removeChild(textArea);
}

// Thinking indicator functions
let thinkingTimeout = null;
let extendedThinkingTimeout = null;

function showThinkingIndicator(form) {
    const thinking = document.getElementById('aria-thinking');
    const thinkingText = document.getElementById('aria-thinking-text');
    const thinkingDetail = document.getElementById('aria-thinking-detail');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = form.querySelector('input[name="message"]');
    const message = messageInput ? messageInput.value.toLowerCase() : '';

    // Determine the appropriate thinking message based on query type
    let baseText = 'Aria is thinking...';
    let detailText = '';
    let showDetail = false;

    // Check for blockout/availability queries (these take longer)
    if (message.includes('blocked out') || message.includes('blockout') ||
        message.includes('availability') || message.includes('available') ||
        message.includes('who is blocked') || message.includes('who\'s blocked')) {
        baseText = 'Aria is checking availability...';
        detailText = 'This may take a moment while checking availability across the team.';
        showDetail = true;
    }
    // Check for schedule/team queries
    else if (message.includes('team') || message.includes('serving') ||
             message.includes('schedule') || message.includes('sunday')) {
        baseText = 'Aria is checking the schedule...';
        detailText = 'Fetching team information from Planning Center.';
    }
    // Check for song queries
    else if (message.includes('song') || message.includes('setlist') ||
             message.includes('played') || message.includes('lyrics') ||
             message.includes('chord')) {
        baseText = 'Aria is looking up song info...';
    }

    thinkingText.textContent = baseText;
    thinkingDetail.textContent = detailText;
    thinkingDetail.classList.toggle('hidden', !showDetail);

    // Move thinking indicator into chat messages and show it
    chatMessages.appendChild(thinking);
    thinking.classList.remove('hidden');

    // Scroll to show the thinking indicator
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // After 5 seconds, show extended message for longer queries
    thinkingTimeout = setTimeout(() => {
        thinkingText.textContent = 'Aria is still working on this...';
        thinkingDetail.textContent = 'Almost there! Complex queries may take a bit longer.';
        thinkingDetail.classList.remove('hidden');
    }, 5000);

    // After 15 seconds, show additional reassurance
    extendedThinkingTimeout = setTimeout(() => {
        thinkingText.textContent = 'Aria is gathering all the information...';
        thinkingDetail.textContent = 'Thank you for your patience. Checking all team members to ensure accurate results.';
    }, 15000);
}

function hideThinkingIndicator() {
    const thinking = document.getElementById('aria-thinking');
    thinking.classList.add('hidden');

    // Clear the timeouts
    if (thinkingTimeout) {
        clearTimeout(thinkingTimeout);
        thinkingTimeout = null;
    }
    if (extendedThinkingTimeout) {
        clearTimeout(extendedThinkingTimeout);
        extendedThinkingTimeout = null;
    }
}
</script>
{% endblock %}
